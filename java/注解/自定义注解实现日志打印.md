## AOP + è‡ªå®šä¹‰æ³¨è§£å®ç°æ—¥å¿—æ‰“å° 
### 1. å…ˆå®šä¹‰ä¸ªæ³¨è§£ï¼Œè®©å®ƒä½œç”¨äºæ–¹æ³•ä¸Š
```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Loggable {

}
```

### 2. å®šä¹‰åˆ‡é¢
```java
@Aspect
@Component
@Slf4j
public class LogMethodCallAspect {

    @Pointcut("@annotation(com.wy.spring_demo.aop.annotation.Loggable)")
    public void logMethodCall() {}
    
    @AfterReturning(pointcut = "logMethodCall()", returning = "result")
    public void logMethodCallAfterReturning(JoinPoint joinPoint, Object result) {
        long startTime = System.currentTimeMillis();
        long executionTime = System.currentTimeMillis() - startTime;

        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();

        log.info("{}.{} params:{} results: {} execution time: {} ms,",
                className,
                methodName,
                joinPoint.getArgs(),
                result,
                executionTime);
    }

}

```

çœ‹ä¸Šå»ä¼¼ä¹ç®€ç®€å•å•ï¼Œæ„Ÿè§‰åªéœ€è¦åœ¨è¦æ‰“å°çš„æ–¹æ³•ä¸ŠåŠ ä¸Šæ³¨è§£å°±okäº†ã€‚
æ‰€ä»¥ç®€å•å®šä¹‰ä¸€ä¸ªcontrolleræµ‹è¯•ä¸€ä¸‹

```java
@RestController
@RequestMapping("/log")
public class LogAnnotationTestController {
    @Resource
    LogAnnotationTestController thisController;

    @Loggable
    @GetMapping("/test/{name}/{age}")
    public String test(@PathVariable("name") String name, @PathVariable("age") int age) {
        return thisController.testService(name, age, "boy");
    }


    @Loggable
    public String testService(String name, int age, String sex) {
        return String.format("%s is %s years old; wy is a %s", name, age, sex);
    }
}
```
å†æ•´ä¸ªhttpå‘è¯·æ±‚
```http request
GET http://localhost:8019/log/test/wy/19
```

å°å°æµ‹è¯•ä¸€ä¸‹ï¼Œå‘é€è¯·æ±‚ï¼š

![image-20231126150649351](./è‡ªå®šä¹‰æ³¨è§£å®ç°æ—¥å¿—æ‰“å°.assets/image-20231126150649351.png)

è¯·æ±‚æˆåŠŸè¢«å“åº”ï¼Œæ£€æŸ¥ä¸€ä¸‹æ—¥å¿—ï¼š

![image-20231126150804308](./è‡ªå®šä¹‰æ³¨è§£å®ç°æ—¥å¿—æ‰“å°.assets/image-20231126150804308.png)

### 3. æ³¨è§£å¤±æ•ˆæƒ…å†µåŠè§£å†³æ–¹æ¡ˆ

ğŸ¤”å¾ˆå¥‡æ€ªï¼Œæ€ä¹ˆæœ‰ä¸ªæ³¨è§£æ²¡ç”Ÿæ•ˆã€‚ã€‚ã€‚ä»€ä¹ˆæƒ…å†µï¼Œå›é¡¾ä¸‹è°ƒç”¨é“¾è·¯ï¼štest -> testServiceï¼ŒtestServiceä¸Šçš„æ³¨è§£æ²¡ç”Ÿæ•ˆã€‚ã€‚ã€‚

æ„Ÿè§‰ä¼¼æ›¾ç›¸è¯†ï¼Œæ€ä¹ˆè‡ªå®šä¹‰çš„æ³¨è§£è·Ÿ @Transactional ä¸€æ ·ï¼Œä¹Ÿä¼šå‡ºç°å¤±æ•ˆï¼Œäºæ˜¯ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹

> åœ¨Spring AOPä¸­ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•å†…éƒ¨è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼ŒAOPåˆ‡é¢æœ‰æ—¶å¯èƒ½æ— æ³•æ‹¦æˆªåˆ°è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œå¯¼è‡´Bæ–¹æ³•ä¸Šçš„æ³¨è§£å¤±æ•ˆã€‚è¿™æ˜¯å› ä¸ºSpring AOPæ˜¯åŸºäºä»£ç†çš„ï¼Œè€Œå¯¹äºå†…éƒ¨è°ƒç”¨ï¼Œä»£ç†å¯¹è±¡å†…éƒ¨çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸ä¼šè§¦å‘åˆ‡é¢çš„ã€‚

é‚£ä¹ˆè§£å†³æ–¹æ¡ˆä¹Ÿæœ‰å¥½å‡ ç§ï¼š

1. é€šè¿‡**ApplicationContext**è·å–Beanï¼Œè¿™æ ·å°±èƒ½ä¿è¯è°ƒç”¨çš„æ˜¯è®²è¿‡spingä»£ç†çš„bean

	```java
	 @Resource
	    private ApplicationContext applicationContext;
	    @Loggable
	    @GetMapping("/test/{name}/{age}")
	    public String test(@PathVariable("name") String name, @PathVariable("age") int age) {
	        LogAnnotationTestController contextBean = applicationContext.getBean(LogAnnotationTestController.class);
	        return contextBean.testService(name, age, "boy");
	    }
	
	
	    @Loggable
	    public String testService(String name, int age, String sex) {
	        return String.format("%s is %s years old; wy is a %s", name, age, sex);
	    }
	```

![image-20231126153012358](./è‡ªå®šä¹‰æ³¨è§£å®ç°æ—¥å¿—æ‰“å°.assets/image-20231126153012358.png)

2. **é€šè¿‡AopContext.currentProxy()è·å–ä»£ç†å¯¹è±¡è¿›è¡Œè°ƒç”¨**

	éœ€è¦å…ˆå¼€å¯ @EnableAspectJAutoProxy(exposeProxy = true) 

	åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ é…ç½®

	![image-20231126153633608](./è‡ªå®šä¹‰æ³¨è§£å®ç°æ—¥å¿—æ‰“å°.assets/image-20231126153633608.png)

```java
 @Loggable
    @GetMapping("/test/{name}/{age}")
    public String test(@PathVariable("name") String name, @PathVariable("age") int age) {
        LogAnnotationTestController logAnnotationTestController = (LogAnnotationTestController) AopContext.currentProxy();
        return logAnnotationTestController.testService(name, age, "boy");
    }


    @Loggable
    public String testService(String name, int age, String sex) {
        return String.format("%s is %s years old; wy is a %s", name, age, sex);
    }
```









